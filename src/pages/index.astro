---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import FormattedDate from '../components/FormattedDate.astro';
import SiteLayout from '../components/SiteLayout.astro';
import TagSidebar from '../components/TagSidebar.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { getFirstImage } from '../utils/postStats';
import { readFile } from 'node:fs/promises';
import { join } from 'node:path';

export const prerender = false;

const allPosts = await getCollection('blog');
const searchParams = Astro.url.searchParams;

const rawTags = [
	...searchParams.getAll('tag'),
	...searchParams.getAll('tags').flatMap((value) => value.split(',')),
];
const activeTags = Array.from(
	new Set(
		rawTags
			.map((tag) => tag.trim())
			.filter((tag) => tag.length > 0)
	)
);
const activeTagSet = new Set(activeTags);
const buildHomeHref = (tags: string[]) =>
	tags.length > 0 ? `/?tags=${tags.map((tag) => encodeURIComponent(tag)).join(',')}` : '/';

const toggleHomeTagHref = (tag: string) => {
	const isActive = activeTagSet.has(tag);
	const nextTags = isActive ? activeTags.filter((t) => t !== tag) : [...activeTags, tag];
	const uniqueNext = Array.from(new Set(nextTags)).sort((a, b) => a.localeCompare(b));
	return buildHomeHref(uniqueNext);
};

const allTags = Array.from(
	new Set(allPosts.flatMap((post) => post.data.tags || []))
).sort();

const filteredPosts = (activeTags.length > 0
	? allPosts.filter((post) => {
			const postTags = post.data.tags || [];
			return activeTags.every((tag) => postTags.includes(tag));
		})
	: allPosts
).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract first image from each post
type PostWithImage = typeof filteredPosts[0] & { firstImage: string | null };

const posts: PostWithImage[] = await Promise.all(
	filteredPosts.map(async (post) => {
		let body = '';
		for (const ext of ['.md', '.mdx']) {
			try {
				const filePath = join(process.cwd(), 'src/content/blog', `${post.id}${ext}`);
				body = await readFile(filePath, 'utf-8');
				break;
			} catch {
				// Continue to next extension
			}
		}
		const firstImage = getFirstImage(body);
		return { ...post, firstImage };
	})
);
---

<!doctype html>
<html lang="zh">
	<head>
		<BaseHead title={`${SITE_TITLE} | 文章`} description={SITE_DESCRIPTION} />
		<style>
			.post-list {
				list-style: none;
				padding: 0;
				margin: 0;
				display: flex;
				flex-direction: column;
				gap: 1.75rem;
			}
			.post-card {
				border-bottom: 1px solid rgba(var(--gray-light), 0.9);
				padding-bottom: 1.75rem;
			}
			.post-card:last-child {
				border-bottom: none;
				padding-bottom: 0;
			}
			.post-card__thumbnail {
				display: block;
				width: 100%;
				height: 180px;
				border-radius: 10px;
				overflow: hidden;
				margin-bottom: 0.75rem;
			}
			.post-card__thumbnail img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			.post-card__meta {
				color: rgba(var(--gray-dark), 0.6);
				font-size: 0.9rem;
				margin-bottom: 0.35rem;
			}
			.post-card__title {
				margin: 0 0 0.5rem 0;
				font-size: 1.6rem;
			}
			.post-card__title a {
				text-decoration: none;
				color: rgb(var(--black));
			}
			.post-card__title a:hover {
				color: rgb(var(--accent));
			}
			.post-card__summary {
				margin: 0 0 0.75rem 0;
				color: rgba(var(--gray-dark), 0.85);
			}
			.post-card__tags {
				display: flex;
				gap: 0.4rem;
				flex-wrap: wrap;
			}
			.blog-empty {
				margin: 0;
				color: rgba(var(--gray-dark), 0.7);
			}
			.blog-header {
				margin-bottom: 1.5rem;
			}
			.blog-header__meta {
				color: rgba(var(--gray-dark), 0.6);
				font-size: 0.9rem;
			}
		</style>
	</head>
	<body>
		<SiteLayout>
			<section class="page-panel">
				<div class="blog-header">
					<p class="eyebrow">Latest writing</p>
					<h1>博客文章</h1>
					<p class="blog-header__meta">
						{activeTags.length > 0 ? `标签：${activeTags.join(' + ')} · ` : ''}共 {posts.length} 篇
					</p>
				</div>
				{
					posts.length === 0 ? (
						<p class="blog-empty">没有找到对应标签的文章。</p>
					) : (
						<ul class="post-list">
							{
								posts.map((post) => (
									<li class="post-card">
										{post.firstImage && (
											<a href={`/blog/${post.id}`} class="post-card__thumbnail">
												<img src={post.firstImage} alt="" loading="lazy" decoding="async" />
											</a>
										)}
										<div class="post-card__meta">
											<FormattedDate date={post.data.date} />
										</div>
										<h2 class="post-card__title">
											<a href={`/blog/${post.id}`}>{post.data.title}</a>
										</h2>
										{
											post.data.summary && (
												<p class="post-card__summary">{post.data.summary}</p>
											)
										}
										{
											post.data.tags && post.data.tags.length > 0 && (
												<div class="post-card__tags">
													{
														post.data.tags.map((tag) => (
															<a href={toggleHomeTagHref(tag)} class="tag-pill">
																#{tag}
															</a>
														))
													}
												</div>
											)
										}
									</li>
								))
							}
						</ul>
					)
				}
			</section>
			<TagSidebar slot="aside" allTags={allTags} activeTags={activeTags} basePath="/" />
		</SiteLayout>
	</body>
</html>
