---
import { getCollection, render } from 'astro:content';
import rehypeSlug from 'rehype-slug';
import BaseHead from '../../components/BaseHead.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import SiteLayout from '../../components/SiteLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Search from '../../components/Search.astro';

export const prerender = true;

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({ params: { slug: post.id } }));
}

const { slug } = Astro.params;
const allPosts = await getCollection('blog');
const post = allPosts.find((entry) => entry.id === slug);

if (!post) {
	return new Response('Not found', { status: 404 });
}

const { Content, headings } = await render(post, {
	remarkPlugins: [],
	rehypePlugins: [rehypeSlug],
});

const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
const hasToc = tocHeadings.length > 0;
const postTags = post.data.tags ?? [];

const relatedPosts = allPosts
	.filter((entry) => entry.id !== post.id && entry.data.tags?.some((tag) => postTags.includes(tag)))
	.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
	.slice(0, 3);

// Get previous and next posts (sorted by date, newest first)
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const currentIndex = sortedPosts.findIndex((p) => p.id === post.id);
const newerPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const olderPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
---

<!doctype html>
<html lang="zh">
	<head>
		<BaseHead title={post.data.title} description={post.data.summary || ''} />
		<style>
			.reading-progress {
				position: fixed;
				top: 0;
				left: 0;
				width: 0%;
				height: 3px;
				background: linear-gradient(90deg, var(--accent), var(--accent-dark));
				z-index: 1000;
				transition: width 0.1s ease-out;
			}
			.post-panel {
				padding: clamp(1.5rem, 3vw, 3rem);
			}
			.post-header {
				margin-bottom: 2rem;
			}
			.post-title {
				margin: 0 0 0.3em 0;
				font-size: clamp(2rem, 4vw, 2.5rem);
			}
			.post-meta {
				color: rgba(var(--gray-dark), 0.65);
				margin-bottom: 1rem;
				font-size: 0.95rem;
			}
			.post-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.4rem;
			}
			.post-content {
				line-height: 1.75;
				color: rgb(var(--gray-dark));
			}
			.post-content :global(h2) {
				font-size: 2.2em;
			}
			.post-content :global(h3) {
				font-size: 1.4em;
			}
			.post-content :global(h2),
			.post-content :global(h3) {
				scroll-margin-top: 1.5rem;
				position: relative;
			}
			.post-content :global(.heading-anchor) {
				position: absolute;
				left: -1.5em;
				top: 50%;
				transform: translateY(-50%);
				font-size: 0.7em;
				color: rgba(var(--gray-dark), 0.3);
				text-decoration: none;
				opacity: 0;
				transition: opacity 0.15s ease, color 0.15s ease;
				padding-right: 0.5em;
			}
			.post-content :global(h2:hover .heading-anchor),
			.post-content :global(h3:hover .heading-anchor),
			.post-content :global(.heading-anchor:focus) {
				opacity: 1;
			}
			.post-content :global(.heading-anchor:hover) {
				color: var(--accent);
			}
			.post-content :global(.heading-anchor.copied) {
				color: var(--accent);
			}
			@media (max-width: 720px) {
				.post-content :global(.heading-anchor) {
					position: static;
					transform: none;
					opacity: 0.5;
					margin-right: 0.3em;
				}
			}
			.post-nav {
				display: flex;
				justify-content: space-between;
				gap: 1rem;
				margin-top: 2.5rem;
				padding-top: 2rem;
				border-top: 1px solid rgba(var(--gray-light), 0.9);
			}
			.post-nav__link {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 0.25rem;
				text-decoration: none;
				padding: 0.75rem 1rem;
				border-radius: 10px;
				transition: background 0.15s ease;
			}
			.post-nav__link:hover {
				background: rgba(var(--gray-light), 0.5);
			}
			.post-nav__link--next {
				text-align: right;
				align-items: flex-end;
			}
			.post-nav__label {
				font-size: 0.8rem;
				color: rgba(var(--gray-dark), 0.6);
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}
			.post-nav__title {
				font-weight: 600;
				color: rgb(var(--black));
				font-size: 0.95rem;
				line-height: 1.4;
			}
			.post-nav__link:hover .post-nav__title {
				color: var(--accent);
			}
			.post-nav__spacer {
				flex: 1;
			}
			@media (max-width: 520px) {
				.post-nav {
					flex-direction: column;
				}
				.post-nav__link--next {
					text-align: left;
					align-items: flex-start;
				}
			}
		</style>
	</head>
	<body>
		<div class="reading-progress" id="reading-progress"></div>
		<SiteLayout>
			<article class="page-panel post-panel" data-pagefind-body>
				<header class="post-header">
					<h1 class="post-title" data-pagefind-meta="title">{post.data.title}</h1>
					{post.data.tags && post.data.tags.length > 0 && (
						<meta data-pagefind-meta={`tags:${post.data.tags.join(', ')}`} />
					)}
					<div class="post-meta">
						<FormattedDate date={post.data.date} />
					</div>
					{
						post.data.tags && post.data.tags.length > 0 && (
							<div class="post-tags">
								{
									post.data.tags.map((tag) => (
										<a href={`/blog?tags=${encodeURIComponent(tag)}`} class="tag-pill">
											#{tag}
										</a>
									))
								}
							</div>
						)
					}
				</header>
				<div class="post-content">
					<Content />
				</div>
				{(olderPost || newerPost) && (
					<nav class="post-nav">
						{olderPost ? (
							<a href={`/blog/${olderPost.id}`} class="post-nav__link">
								<span class="post-nav__label">← 上一篇</span>
								<span class="post-nav__title">{olderPost.data.title}</span>
							</a>
						) : (
							<div class="post-nav__spacer"></div>
						)}
						{newerPost ? (
							<a href={`/blog/${newerPost.id}`} class="post-nav__link post-nav__link--next">
								<span class="post-nav__label">下一篇 →</span>
								<span class="post-nav__title">{newerPost.data.title}</span>
							</a>
						) : (
							<div class="post-nav__spacer"></div>
						)}
					</nav>
				)}
			</article>
			<RelatedPosts posts={relatedPosts} />
			<Fragment slot="aside">
				<Search />
				{hasToc && <TableOfContents headings={tocHeadings} />}
			</Fragment>
		</SiteLayout>

		<script>
			// Reading progress bar
			const progressBar = document.getElementById('reading-progress');

			function updateProgress() {
				const scrollTop = window.scrollY;
				const docHeight = document.documentElement.scrollHeight - window.innerHeight;
				const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
				if (progressBar) {
					progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
				}
			}

			window.addEventListener('scroll', updateProgress, { passive: true });
			window.addEventListener('resize', updateProgress, { passive: true });
			updateProgress();

			// Heading anchor links
			const postContent = document.querySelector('.post-content');
			if (postContent) {
				const headings = postContent.querySelectorAll('h2[id], h3[id]');
				headings.forEach((heading) => {
					const anchor = document.createElement('a');
					anchor.href = `#${heading.id}`;
					anchor.className = 'heading-anchor';
					anchor.textContent = '#';
					anchor.setAttribute('aria-label', `Link to ${heading.textContent}`);
					
					anchor.addEventListener('click', async (e) => {
						e.preventDefault();
						const url = `${window.location.origin}${window.location.pathname}#${heading.id}`;
						try {
							await navigator.clipboard.writeText(url);
							anchor.classList.add('copied');
							setTimeout(() => anchor.classList.remove('copied'), 1500);
						} catch {
							// Fallback: just navigate to the anchor
							window.location.hash = heading.id;
						}
					});
					
					heading.insertBefore(anchor, heading.firstChild);
				});
			}
		</script>
	</body>
</html>
